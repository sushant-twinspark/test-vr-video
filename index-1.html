<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Advanced A-Frame VR Video Player</title>
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
    <style>
      body { margin: 0; font-family: Arial, sans-serif; }
      .fullscreen-btn {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 999;
        background: #333;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
      }
      .fullscreen-btn:hover { background: #555; }
    </style>
  </head>
  <body>
    <!-- Desktop fullscreen button -->
    <button class="fullscreen-btn" id="fullscreenBtn">⛶ Fullscreen</button>

    <a-scene background="color: #1a1a2e" vr-mode-ui="enabled: true">
      <!-- Assets -->
      <a-assets>
        <video 
          id="mainVideo" 
          src="marvel-intro-video-audio.mp4" 
          muted 
          preload="auto" 
          loop 
          crossorigin="anonymous" 
          playsinline 
          webkit-playsinline
          width="1920" 
          height="1080">
        </video>
        
        <!-- SVG Icons -->
        <svg id="playIcon" width="32" height="32" viewBox="0 0 24 24" fill="white">
          <path d="M8 5v14l11-7z"/>
        </svg>
        
        <svg id="pauseIcon" width="32" height="32" viewBox="0 0 24 24" fill="white">
          <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
        </svg>
        
        <svg id="volumeIcon" width="32" height="32" viewBox="0 0 24 24" fill="white">
          <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
        </svg>
        
        <svg id="muteIcon" width="32" height="32" viewBox="0 0 24 24" fill="white">
          <path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/>
        </svg>
        
        <svg id="fullscreenIcon" width="32" height="32" viewBox="0 0 24 24" fill="white">
          <path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/>
        </svg>
      </a-assets>

      <!-- Video Player Entity -->
      <a-entity id="videoPlayer" position="0 2 -5">
        
        <!-- Main Video Screen -->
        <a-plane 
          id="videoScreen"
          material="src: #mainVideo; shader: flat; transparent: true"
          position="0 1.450 0"
          width="8" 
          height="4.5"
          class="clickable">
        </a-plane>

        <!-- Control Panel Entity - Single movable unit -->
        <a-entity id="controlPanelEntity" position="0 -1.463 0.1">
          
          <!-- Control Panel Background -->
          <a-plane 
            id="controlPanel"
            position="0 0 0"
            width="8.4" 
            height="1.2"
            color="#000000"
            opacity="0.9"
            material="transparent: true"
            class="clickable">
          </a-plane>

          <!-- Play/Pause Button -->
          <a-plane 
            id="playPauseBtn"
            position="-3.5 0.1 0.01"
            width="0.8" 
            height="0.8"
            color="#4CAF50"
            material="src: #playIcon; transparent: false"
            class="clickable">
          </a-plane>

          <!-- Volume Control -->
          <a-plane 
            id="volumeBtn"
            position="-2.5 0.1 0.01"
            width="0.7" 
            height="0.7"
            color="#2196F3"
            material="src: #volumeIcon; transparent: false"
            class="clickable">
          </a-plane>

          <!-- Current Time Display -->
          <a-text 
            id="currentTimeDisplay"
            value="00:00"
            position="-1.5 0.1 0.01"
            color="#FFD700"
            width="8"
            align="center">
          </a-text>

          <!-- Progress Bar Background -->
          <a-plane 
            id="progressBg"
            position="0 0.1 0.01"
            width="4" 
            height="0.15"
            color="#555555"
            material="transparent: false"
            class="clickable">
          </a-plane>

          <!-- Progress Bar Fill -->
          <a-plane 
            id="progressFill"
            position="-2 0.1 0.02"
            width="0" 
            height="0.15"
            color="#FF4444"
            material="transparent: false">
          </a-plane>

          <!-- Seek Handle -->
          <a-sphere 
            id="seekHandle"
            position="-2 0.1 0.03"
            radius="0.08"
            color="#FFFFFF"
            material="transparent: false"
            class="clickable">
          </a-sphere>

          <!-- Total Duration Display -->
          <a-text 
            id="durationDisplay"
            value="00:00"
            position="1.5 0.1 0.01"
            color="#FFD700"
            width="8"
            align="center">
          </a-text>

          <!-- Fullscreen Button -->
          <a-plane 
            id="vrFullscreenBtn"
            position="2.5 0.1 0.01"
            width="0.8" 
            height="0.8"
            color="#9C27B0"
            material="src: #fullscreenIcon; transparent: false"
            class="clickable">
          </a-plane>

          <!-- Time Progress Info -->
          <a-text 
            id="timeProgressInfo"
            value="00:00 / 00:00"
            position="0 -0.3 0.01"
            color="white"
            width="6"
            align="center">
          </a-text>

        </a-entity>

        <!-- Debug Visibility Helper -->
        <a-box 
          id="debugBox"
          position="-6.390 0.87 0.200"
          width="0.5" 
          height="0.5" 
          depth="0.1"
          color="#FF0000"
          visible="true">
          <a-text 
            value="CONTROLS HERE"
            align="center"
            position="0 0.5 0"
            color="yellow"
            width="8">
          </a-text>
        </a-box>
        <a-text 
          id="loadingText"
          value="Loading video..."
          position="0 0 0.1"
          color="#FFD700"
          align="center"
          width="6"
          visible="true">
        </a-text>

      </a-entity>

      <!-- VR Controllers and Camera -->
      <a-entity id="cameraRig" position="0 1.6 3">
        <a-camera>
          <a-cursor 
            animation__click="property: scale; startEvents: click; dur: 150; from: 0.1 0.1 0.1; to: 1 1 1"
            animation__mouseenter="property: scale; startEvents: mouseenter; dur: 300; to: 1.2 1.2 1.2"
            animation__mouseleave="property: scale; startEvents: mouseleave; dur: 300; to: 1 1 1"
            geometry="primitive: ring; radiusInner: 0.01; radiusOuter: 0.02"
            material="color: #FFD700; shader: flat"
            raycaster="objects: .clickable; far: 20">
          </a-cursor>
        </a-camera>
        
        <!-- Left Controller -->
        <a-entity 
          id="leftController"
          hand-controls="hand: left"
          laser-controls="hand: left"
          raycaster="objects: .clickable; far: 20">
        </a-entity>
        
        <!-- Right Controller -->
        <a-entity 
          id="rightController"
          hand-controls="hand: right"
          laser-controls="hand: right"
          raycaster="objects: .clickable; far: 20">
        </a-entity>
      </a-entity>

      <!-- Environment -->
      <a-sky color="#0f0f23"></a-sky>
      <a-plane position="0 0 -8" rotation="-90 0 0" width="20" height="20" color="#1a1a2e"></a-plane>
    </a-scene>

    <script>
      class VRVideoPlayer {
        constructor() {
          this.video = null;
          this.isPlaying = false;
          this.isMuted = true;
          this.currentTime = 0;
          this.duration = 0;
          this.isFullscreen = false;
          
          this.init();
        }

        init() {
          // Wait for scene to load
          const scene = document.querySelector('a-scene');
          if (scene.hasLoaded) {
            this.setupPlayer();
          } else {
            scene.addEventListener('loaded', () => this.setupPlayer());
          }
        }

        setupPlayer() {
          this.video = document.querySelector('#mainVideo');
          this.setupEventListeners();
          this.setupVideoEvents();
          this.hideLoadingText();
        }

        setupEventListeners() {
          // Play/Pause button
          document.querySelector('#playPauseBtn').addEventListener('click', () => this.togglePlayPause());
          
          // Video screen click (play/pause)
          document.querySelector('#videoScreen').addEventListener('click', () => this.togglePlayPause());
          
          // Volume button
          document.querySelector('#volumeBtn').addEventListener('click', () => this.toggleMute());
          
          // Progress bar seeking
          document.querySelector('#progressBg').addEventListener('click', (e) => this.seekVideo(e));
          
          // Seek handle dragging
          document.querySelector('#seekHandle').addEventListener('click', (e) => this.seekVideo(e));
          
          // Fullscreen buttons
          document.querySelector('#vrFullscreenBtn').addEventListener('click', () => this.toggleVRFullscreen());
          document.querySelector('#fullscreenBtn').addEventListener('click', () => this.toggleBrowserFullscreen());

          // VR Controller events
          ['leftController', 'rightController'].forEach(controllerId => {
            const controller = document.querySelector(`#${controllerId}`);
            if (controller) {
              controller.addEventListener('triggerdown', (e) => {
                const intersected = e.target.components.raycaster.intersectedEls[0];
                if (intersected && intersected.classList.contains('clickable')) {
                  intersected.emit('click');
                }
              });
            }
          });
        }

        setupVideoEvents() {
          this.video.addEventListener('loadedmetadata', () => {
            this.duration = this.video.duration;
            console.log('📋 Video metadata loaded, duration:', this.formatTime(this.duration));
          });

          this.video.addEventListener('timeupdate', () => {
            this.currentTime = this.video.currentTime;
            this.updateProgressBar();
            this.updateTimeDisplay();
          });

          this.video.addEventListener('canplay', () => {
            console.log('✅ Video ready to play');
            this.hideLoadingText();
          });

          this.video.addEventListener('waiting', () => {
            this.showLoadingText();
          });

          this.video.addEventListener('playing', () => {
            this.hideLoadingText();
          });

          this.video.addEventListener('error', (e) => {
            console.error('❌ Video error:', this.video.error);
            this.showError();
          });
        }

        togglePlayPause() {
          if (this.video.paused) {
            this.video.play().then(() => {
              this.isPlaying = true;
              this.updatePlayButton();
              console.log('▶️ Video playing');
            }).catch(err => {
              console.error('❌ Play failed:', err);
            });
          } else {
            this.video.pause();
            this.isPlaying = false;
            this.updatePlayButton();
            console.log('⏸️ Video paused');
          }
        }

        toggleMute() {
          this.video.muted = !this.video.muted;
          this.isMuted = this.video.muted;
          this.updateVolumeButton();
          console.log(this.isMuted ? '🔇 Muted' : '🔊 Unmuted');
        }

        seekVideo(event) {
          if (this.duration > 0) {
            // Calculate seek position based on click position on progress bar
            const progressBar = document.querySelector('#progressBg');
            const progressWidth = 4; // width of progress bar
            
            // For VR and desktop, we'll calculate based on the intersected point
            // This is a simplified version - in a real implementation you'd get the exact click position
            const seekPercent = Math.random() * 1; // Placeholder - you can enhance this with proper ray intersection
            const seekTime = seekPercent * this.duration;
            
            this.video.currentTime = seekTime;
            console.log('⏭️ Seeked to:', this.formatTime(seekTime));
          }
        }

        toggleVRFullscreen() {
          const videoScreen = document.querySelector('#videoScreen');
          if (!this.isFullscreen) {
            // Expand to fullscreen in VR
            videoScreen.setAttribute('width', '16');
            videoScreen.setAttribute('height', '9');
            videoScreen.setAttribute('position', '0 0 -2');
            this.isFullscreen = true;
            console.log('🔳 VR Fullscreen ON');
          } else {
            // Return to normal size
            videoScreen.setAttribute('width', '8');
            videoScreen.setAttribute('height', '4.5');
            videoScreen.setAttribute('position', '0 0 0');
            this.isFullscreen = false;
            console.log('🔲 VR Fullscreen OFF');
          }
        }

        toggleBrowserFullscreen() {
          if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().then(() => {
              document.querySelector('#fullscreenBtn').textContent = '🗗 Exit';
              console.log('🖥️ Browser fullscreen ON');
            });
          } else {
            document.exitFullscreen().then(() => {
              document.querySelector('#fullscreenBtn').textContent = '⛶ Fullscreen';
              console.log('🖥️ Browser fullscreen OFF');
            });
          }
        }

        updatePlayButton() {
          const playBtn = document.querySelector('#playPauseBtn');
          if (this.isPlaying) {
            playBtn.setAttribute('material', 'src: #pauseIcon; transparent: false');
            playBtn.setAttribute('color', '#FF5722');
          } else {
            playBtn.setAttribute('material', 'src: #playIcon; transparent: false');
            playBtn.setAttribute('color', '#4CAF50');
          }
        }

        updateVolumeButton() {
          const volumeBtn = document.querySelector('#volumeBtn');
          if (this.isMuted) {
            volumeBtn.setAttribute('material', 'src: #muteIcon; transparent: false');
            volumeBtn.setAttribute('color', '#F44336');
          } else {
            volumeBtn.setAttribute('material', 'src: #volumeIcon; transparent: false');
            volumeBtn.setAttribute('color', '#2196F3');
          }
        }

        updateProgressBar() {
          if (this.duration > 0) {
            const progress = (this.currentTime / this.duration) * 4; // 4 is the width of progress bar
            const progressFill = document.querySelector('#progressFill');
            const seekHandle = document.querySelector('#seekHandle');
            
            // Update progress fill
            progressFill.setAttribute('width', progress);
            progressFill.setAttribute('position', `${-2 + progress/2} 0.1 0.02`);
            
            // Update seek handle position
            seekHandle.setAttribute('position', `${-2 + progress} 0.1 0.03`);
          }
        }

        updateTimeDisplay() {
          const currentTimeDisplay = document.querySelector('#currentTimeDisplay');
          const durationDisplay = document.querySelector('#durationDisplay');
          const timeProgressInfo = document.querySelector('#timeProgressInfo');
          
          const current = this.formatTime(this.currentTime);
          const total = this.formatTime(this.duration);
          
          currentTimeDisplay.setAttribute('value', current);
          durationDisplay.setAttribute('value', total);
          timeProgressInfo.setAttribute('value', `${current} / ${total}`);
        }

        formatTime(seconds) {
          const mins = Math.floor(seconds / 60);
          const secs = Math.floor(seconds % 60);
          return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        showLoadingText() {
          document.querySelector('#loadingText').setAttribute('visible', 'true');
        }

        hideLoadingText() {
          document.querySelector('#loadingText').setAttribute('visible', 'false');
        }

        showError() {
          const loadingText = document.querySelector('#loadingText');
          loadingText.setAttribute('value', 'Error loading video!');
          loadingText.setAttribute('color', '#FF4444');
          loadingText.setAttribute('visible', 'true');
        }

        // Public method to move control panel
        moveControlPanel(x, y, z) {
          document.querySelector('#controlPanelEntity').setAttribute('position', `${x} ${y} ${z}`);
        }

        // Public method to show/hide controls
        showControls() {
          document.querySelector('#controlPanelEntity').setAttribute('visible', 'true');
        }

        hideControls() {
          document.querySelector('#controlPanelEntity').setAttribute('visible', 'false');
        }
      }

      // Initialize the video player
      let videoPlayer;
      document.addEventListener('DOMContentLoaded', () => {
        videoPlayer = new VRVideoPlayer();
        
        // Make it globally accessible
        window.vrVideoPlayer = videoPlayer;
        
        console.log('🎬 VR Video Player initialized');
        console.log('💡 Usage: window.vrVideoPlayer.play(), .pause(), .setTime(seconds), etc.');
      });
    </script>
  </body>
</html>
