<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Advanced A-Frame VR Video Player</title>
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
    <style>
      body { margin: 0; font-family: Arial, sans-serif; }
      .fullscreen-btn {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 999;
        background: #333;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
      }
      .fullscreen-btn:hover { background: #555; }
    </style>
  </head>
  <body>
    <!-- Desktop fullscreen button -->
    <button class="fullscreen-btn" id="fullscreenBtn">â›¶ Fullscreen</button>

    <a-scene background="color: #1a1a2e" vr-mode-ui="enabled: true">
      <!-- Assets -->
      <a-assets>
        <video 
          id="mainVideo" 
          src="marvel-intro-video-audio.mp4" 
          muted 
          preload="auto" 
          loop 
          crossorigin="anonymous" 
          playsinline 
          webkit-playsinline
          width="1920" 
          height="1080">
        </video>
        
        <!-- Image Textures for Icons -->
        <img id="playIcon" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0id2hpdGUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHBhdGggZD0iTTggNXYxNGwxMS03eiIvPjwvc3ZnPg==" crossorigin="anonymous">
        
        <img id="pauseIcon" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0id2hpdGUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHBhdGggZD0iTTYgMTloNFY1SDZ2MTR6bTgtMTR2MTRoNFY1aC00eiIvPjwvc3ZnPg==" crossorigin="anonymous">
        
        <img id="volumeIcon" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0id2hpdGUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHBhdGggZD0iTTMgOXY2aDRsNSA1VjRMNyA5SDN6bTEzLjUgM2MwLTEuNzctMS4wMi0zLjI5LTIuNS00LjAzdjguMDVjMS40OC0uNzMgMi41LTIuMjUgMi41LTQuMDJ6Ii8+PC9zdmc+" crossorigin="anonymous">
        
        <img id="muteIcon" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0id2hpdGUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHBhdGggZD0iTTMgOXY2aDRsNSA1VjRMNyA5SDN6bTE2LjUgM2MwIDIuNjEtMS4zOCA0LjktMy41IDUuNjRWMTZjMS4wMi0uNTIgMS43NS0xLjU0IDEuNzUtMi43NXMtLjczLTIuMjMtMS43NS0yLjc1djEuMjV6Ii8+PC9zdmc+" crossorigin="anonymous">
        
        <img id="fullscreenIcon" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjQiIGhlaWdodD0iNjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0id2hpdGUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHBhdGggZD0iTTcgMTRINXY1aDV2LTJIN3YtM3ptLTItNGgyVjdoM1Y1SDV2NXptMTIgN2gtM3YyaDV2LTVoLTJ2M3pNMTQgNXYyaDN2M2gyVjVoLTV6Ii8+PC9zdmc+" crossorigin="anonymous">
      </a-assets>
      </a-assets>

      <!-- Video Player Entity -->
      <a-entity id="videoPlayer" position="0 2 -5">
        
        <!-- Main Video Screen -->
        <a-plane 
          id="videoScreen"
          material="src: #mainVideo; shader: flat; transparent: true"
          position="0 0 0"
          width="8" 
          height="4.5"
          class="clickable">
        </a-plane>

        <!-- Control Panel Entity - Single movable unit -->
        <a-entity id="controlPanelEntity" position="0 3 0.1">
          
          <!-- Play/Pause Button -->
          <a-plane 
            id="playPauseBtn"
            position="-3.5 0.1 0.01"
            width="0.8" 
            height="0.8"
            color="#4CAF50"
            material="src: #playIcon; transparent: false"
            class="clickable">
          </a-plane>

          <!-- Volume Control -->
          <a-plane 
            id="volumeBtn"
            position="-2.5 0.1 0.01"
            width="0.7" 
            height="0.7"
            color="#2196F3"
            material="src: #volumeIcon; transparent: false"
            class="clickable">
          </a-plane>

          <!-- Current Time Display Background -->
          <a-plane 
            position="-1.5 0.1 0"
            width="1.2" 
            height="0.4"
            color="#000000"
            opacity="0.7"
            material="transparent: true">
          </a-plane>

          <!-- Current Time Display -->
          <a-text 
            id="currentTimeDisplay"
            value="00:00"
            position="-1.5 0.1 0.01"
            color="#FFD700"
            width="8"
            align="center">
          </a-text>

          <!-- Progress Bar Background -->
          <a-plane 
            id="progressBg"
            position="0 0.1 0.01"
            width="4" 
            height="0.15"
            color="#555555"
            material="transparent: false"
            class="clickable">
          </a-plane>

          <!-- Progress Bar Fill -->
          <a-plane 
            id="progressFill"
            position="-2 0.1 0.02"
            width="0" 
            height="0.15"
            color="#FF4444"
            material="transparent: false">
          </a-plane>

          <!-- Seek Handle -->
          <a-sphere 
            id="seekHandle"
            position="-2 0.1 0.03"
            radius="0.08"
            color="#FFFFFF"
            material="transparent: false"
            class="clickable">
          </a-sphere>

          <!-- Total Duration Display Background -->
          <a-plane 
            position="1.5 0.1 0"
            width="1.2" 
            height="0.4"
            color="#000000"
            opacity="0.7"
            material="transparent: true">
          </a-plane>

          <!-- Total Duration Display -->
          <a-text 
            id="durationDisplay"
            value="00:00"
            position="1.5 0.1 0.01"
            color="#FFD700"
            width="8"
            align="center">
          </a-text>

          <!-- Fullscreen Button -->
          <a-plane 
            id="vrFullscreenBtn"
            position="2.5 0.1 0.01"
            width="0.8" 
            height="0.8"
            color="#9C27B0"
            material="src: #fullscreenIcon; transparent: false"
            class="clickable">
          </a-plane>

          <!-- Combined Time Progress Info -->
          <a-plane 
            position="0 -0.3 0"
            width="3" 
            height="0.4"
            color="#000000"
            opacity="0.7"
            material="transparent: true">
          </a-plane>

          <!-- Time Progress Info -->
          <a-text 
            id="timeProgressInfo"
            value="00:00 / 00:00"
            position="0 -0.3 0.01"
            color="white"
            width="6"
            align="center">
          </a-text>

        </a-entity>

        <!-- Debug Visibility Helper -->
        <a-box 
          id="debugBox"
          position="0 -2.5 0.2"
          width="0.5" 
          height="0.5" 
          depth="0.1"
          color="#FF0000"
          visible="true">
          <a-text 
            value="CONTROLS HERE"
            align="center"
            position="0 0.5 0"
            color="yellow"
            width="8">
          </a-text>
        </a-box>
        <a-text 
          id="loadingText"
          value="Loading video..."
          position="0 0 0.1"
          color="#FFD700"
          align="center"
          width="6"
          visible="true">
        </a-text>

      </a-entity>

      <!-- VR Controllers and Camera -->
      <a-entity id="cameraRig" position="0 1.6 3">
        <a-camera 
          look-controls="pointerLockEnabled: false"
          wasd-controls="enabled: true">
          <!-- Desktop cursor for browser mode -->
          <a-cursor 
            geometry="primitive: ring; radiusInner: 0.005; radiusOuter: 0.01"
            material="color: #FFD700; shader: flat"
            raycaster="objects: .clickable; far: 20"
            animation__click="property: scale; startEvents: click; dur: 100; from: 0.8 0.8 0.8; to: 1.2 1.2 1.2"
            animation__mouseenter="property: scale; startEvents: mouseenter; dur: 200; to: 1.3 1.3 1.3"
            animation__mouseleave="property: scale; startEvents: mouseleave; dur: 200; to: 1 1 1">
          </a-cursor>
        </a-camera>
        
        <!-- Left Controller -->
        <a-entity 
          id="leftController"
          hand-controls="hand: left"
          laser-controls="hand: left"
          raycaster="objects: .clickable; far: 20; showLine: true; lineColor: #FFD700; lineOpacity: 0.8">
        </a-entity>
        
        <!-- Right Controller -->
        <a-entity 
          id="rightController"
          hand-controls="hand: right" 
          laser-controls="hand: right"
          raycaster="objects: .clickable; far: 20; showLine: true; lineColor: #FFD700; lineOpacity: 0.8">
        </a-entity>
      </a-entity>

      <!-- Environment -->
      <a-sky color="#0f0f23"></a-sky>
      <a-plane position="0 0 -8" rotation="-90 0 0" width="20" height="20" color="#1a1a2e"></a-plane>
    </a-scene>

    <script>
      class VRVideoPlayer {
        constructor() {
          this.video = null;
          this.isPlaying = false;
          this.isMuted = true;
          this.currentTime = 0;
          this.duration = 0;
          this.isFullscreen = false;
          
          this.init();
        }

        init() {
          // Wait for scene to load
          const scene = document.querySelector('a-scene');
          if (scene.hasLoaded) {
            this.setupPlayer();
          } else {
            scene.addEventListener('loaded', () => this.setupPlayer());
          }
        }

        setupPlayer() {
          this.video = document.querySelector('#mainVideo');
          this.setupEventListeners();
          this.setupVideoEvents();
          this.hideLoadingText();
        }

        setupEventListeners() {
          // Enhanced event handling for both VR and browser
          this.setupButtonEvents('#playPauseBtn', () => {
            console.log('ðŸŽ® Play/Pause activated');
            this.togglePlayPause();
          });

          this.setupButtonEvents('#volumeBtn', () => {
            console.log('ðŸ”Š Volume activated');
            this.toggleMute();
          });

          this.setupButtonEvents('#vrFullscreenBtn', () => {
            console.log('â›¶ Fullscreen activated');
            this.toggleVRFullscreen();
          });

          this.setupButtonEvents('#progressBg', (e) => {
            console.log('ðŸ“Š Progress bar activated');
            this.seekVideo(e);
          });

          this.setupButtonEvents('#seekHandle', (e) => {
            console.log('ðŸŽ¯ Seek handle activated');
            this.seekVideo(e);
          });
          
          // Video screen click (play/pause)
          this.setupButtonEvents('#videoScreen', () => {
            console.log('ðŸ“º Video screen activated');
            this.togglePlayPause();
          });
          
          // Desktop fullscreen
          document.querySelector('#fullscreenBtn').addEventListener('click', () => this.toggleBrowserFullscreen());

          // VR Controller - Instant trigger response
          ['leftController', 'rightController'].forEach(controllerId => {
            const controller = document.querySelector(`#${controllerId}`);
            if (controller) {
              // Trigger down - immediate response
              controller.addEventListener('triggerdown', (e) => {
                const intersected = e.target.components.raycaster.intersectedEls[0];
                if (intersected && intersected.classList.contains('clickable')) {
                  console.log('ðŸ•¹ï¸ VR Trigger DOWN:', intersected.id);
                  intersected.emit('click');
                }
              });
              
              // Trigger up - for completion (optional)
              controller.addEventListener('triggerup', (e) => {
                console.log('ðŸ•¹ï¸ VR Trigger UP');
              });
            }
          });
        }

        // Helper method to set up consistent button events
        setupButtonEvents(selector, callback) {
          const element = document.querySelector(selector);
          if (element) {
            // Browser mouse events
            element.addEventListener('click', callback);
            element.addEventListener('mousedown', callback);
            
            // Touch events for mobile
            element.addEventListener('touchstart', callback);
            
            // VR cursor events (if cursor is enabled)
            element.addEventListener('mouseenter', () => {
              element.setAttribute('scale', '1.1 1.1 1.1');
            });
            element.addEventListener('mouseleave', () => {
              element.setAttribute('scale', '1 1 1');
            });
          }
        }

        setupVideoEvents() {
          this.video.addEventListener('loadedmetadata', () => {
            this.duration = this.video.duration;
            this.updateTimeDisplay(); // Update duration display immediately
            console.log('ðŸ“‹ Video metadata loaded, duration:', this.formatTime(this.duration));
          });

          this.video.addEventListener('loadeddata', () => {
            this.duration = this.video.duration;
            this.updateTimeDisplay(); // Ensure duration is shown
            console.log('ðŸ“Š Video data loaded, duration set to:', this.formatTime(this.duration));
          });

          this.video.addEventListener('timeupdate', () => {
            this.currentTime = this.video.currentTime;
            this.updateProgressBar();
            this.updateTimeDisplay();
          });

          this.video.addEventListener('canplay', () => {
            console.log('âœ… Video ready to play');
            this.hideLoadingText();
            // Force duration update when ready to play
            if (this.video.duration) {
              this.duration = this.video.duration;
              this.updateTimeDisplay();
            }
          });

          this.video.addEventListener('durationchange', () => {
            this.duration = this.video.duration;
            this.updateTimeDisplay();
            console.log('â° Duration changed to:', this.formatTime(this.duration));
          });

          this.video.addEventListener('waiting', () => {
            this.showLoadingText();
          });

          this.video.addEventListener('playing', () => {
            this.hideLoadingText();
          });

          this.video.addEventListener('error', (e) => {
            console.error('âŒ Video error:', this.video.error);
            this.showError();
          });
        }

        togglePlayPause() {
          if (this.video.paused) {
            this.video.play().then(() => {
              this.isPlaying = true;
              this.updatePlayButton();
              console.log('â–¶ï¸ Video playing');
            }).catch(err => {
              console.error('âŒ Play failed:', err);
            });
          } else {
            this.video.pause();
            this.isPlaying = false;
            this.updatePlayButton();
            console.log('â¸ï¸ Video paused');
          }
        }

        toggleMute() {
          this.video.muted = !this.video.muted;
          this.isMuted = this.video.muted;
          this.updateVolumeButton();
          console.log(this.isMuted ? 'ðŸ”‡ Muted' : 'ðŸ”Š Unmuted');
        }

        seekVideo(event) {
          if (this.duration > 0) {
            // Get the intersection point for proper seeking
            const intersection = event.detail.intersection;
            const progressBar = document.querySelector('#progressBg');
            
            if (intersection) {
              // Get the local position on the progress bar
              const localPoint = intersection.point;
              const progressBarWorldPos = progressBar.object3D.getWorldPosition(new THREE.Vector3());
              
              // Calculate relative position (simplified for VR)
              const relativeX = localPoint.x - progressBarWorldPos.x;
              const progressBarWidth = 4; // width of progress bar
              
              // Convert to percentage (clamp between 0 and 1)
              let seekPercent = (relativeX + progressBarWidth/2) / progressBarWidth;
              seekPercent = Math.max(0, Math.min(1, seekPercent));
              
              const seekTime = seekPercent * this.duration;
              this.video.currentTime = seekTime;
              
              console.log(`â­ï¸ Seeked to: ${this.formatTime(seekTime)} (${Math.round(seekPercent * 100)}%)`);
            } else {
              // Fallback for cases where intersection is not available
              const seekTime = this.duration * 0.5; // Jump to middle
              this.video.currentTime = seekTime;
              console.log('â­ï¸ Seeked to middle:', this.formatTime(seekTime));
            }
          }
        }

        toggleVRFullscreen() {
          const videoScreen = document.querySelector('#videoScreen');
          if (!this.isFullscreen) {
            // Expand to fullscreen in VR
            videoScreen.setAttribute('width', '16');
            videoScreen.setAttribute('height', '9');
            videoScreen.setAttribute('position', '0 0 -2');
            this.isFullscreen = true;
            console.log('ðŸ”³ VR Fullscreen ON');
          } else {
            // Return to normal size
            videoScreen.setAttribute('width', '8');
            videoScreen.setAttribute('height', '4.5');
            videoScreen.setAttribute('position', '0 0 0');
            this.isFullscreen = false;
            console.log('ðŸ”² VR Fullscreen OFF');
          }
        }

        toggleBrowserFullscreen() {
          if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().then(() => {
              document.querySelector('#fullscreenBtn').textContent = 'ðŸ—— Exit';
              console.log('ðŸ–¥ï¸ Browser fullscreen ON');
            });
          } else {
            document.exitFullscreen().then(() => {
              document.querySelector('#fullscreenBtn').textContent = 'â›¶ Fullscreen';
              console.log('ðŸ–¥ï¸ Browser fullscreen OFF');
            });
          }
        }

        updatePlayButton() {
          const playBtn = document.querySelector('#playPauseBtn');
          if (this.isPlaying) {
            playBtn.setAttribute('material', 'src: #pauseIcon; transparent: false');
            playBtn.setAttribute('color', '#FF5722');
          } else {
            playBtn.setAttribute('material', 'src: #playIcon; transparent: false');
            playBtn.setAttribute('color', '#4CAF50');
          }
        }

        updateVolumeButton() {
          const volumeBtn = document.querySelector('#volumeBtn');
          if (this.isMuted) {
            volumeBtn.setAttribute('material', 'src: #muteIcon; transparent: false');
            volumeBtn.setAttribute('color', '#F44336');
          } else {
            volumeBtn.setAttribute('material', 'src: #volumeIcon; transparent: false');
            volumeBtn.setAttribute('color', '#2196F3');
          }
        }

        updateProgressBar() {
          if (this.duration > 0) {
            const progress = (this.currentTime / this.duration) * 4; // 4 is the width of progress bar
            const progressFill = document.querySelector('#progressFill');
            const seekHandle = document.querySelector('#seekHandle');
            
            // Update progress fill
            progressFill.setAttribute('width', progress);
            progressFill.setAttribute('position', `${-2 + progress/2} 0.1 0.02`);
            
            // Update seek handle position
            seekHandle.setAttribute('position', `${-2 + progress} 0.1 0.03`);
          }
        }

        updateTimeDisplay() {
          const currentTimeDisplay = document.querySelector('#currentTimeDisplay');
          const durationDisplay = document.querySelector('#durationDisplay');
          const timeProgressInfo = document.querySelector('#timeProgressInfo');
          
          const current = this.formatTime(this.currentTime || 0);
          const total = this.formatTime(this.duration || 0);
          
          if (currentTimeDisplay) currentTimeDisplay.setAttribute('value', current);
          if (durationDisplay) durationDisplay.setAttribute('value', total);
          if (timeProgressInfo) timeProgressInfo.setAttribute('value', `${current} / ${total}`);
        }

        formatTime(seconds) {
          if (!seconds || isNaN(seconds) || seconds === Infinity) {
            return '00:00';
          }
          const mins = Math.floor(seconds / 60);
          const secs = Math.floor(seconds % 60);
          return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        showLoadingText() {
          document.querySelector('#loadingText').setAttribute('visible', 'true');
        }

        hideLoadingText() {
          document.querySelector('#loadingText').setAttribute('visible', 'false');
        }

        showError() {
          const loadingText = document.querySelector('#loadingText');
          loadingText.setAttribute('value', 'Error loading video!');
          loadingText.setAttribute('color', '#FF4444');
          loadingText.setAttribute('visible', 'true');
        }

        // Public method to move control panel
        moveControlPanel(x, y, z) {
          document.querySelector('#controlPanelEntity').setAttribute('position', `${x} ${y} ${z}`);
        }

        // Public method to show/hide controls
        showControls() {
          document.querySelector('#controlPanelEntity').setAttribute('visible', 'true');
        }

        hideControls() {
          document.querySelector('#controlPanelEntity').setAttribute('visible', 'false');
        }
      }

      // Initialize the video player
      let videoPlayer;
      document.addEventListener('DOMContentLoaded', () => {
        videoPlayer = new VRVideoPlayer();
        
        // Make it globally accessible
        window.vrVideoPlayer = videoPlayer;
        
        console.log('ðŸŽ¬ VR Video Player initialized');
        console.log('ðŸ’¡ Usage: window.vrVideoPlayer.play(), .pause(), .setTime(seconds), etc.');
      });
    </script>
  </body>
</html>
